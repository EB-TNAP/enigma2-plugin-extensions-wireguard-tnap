# Enigma2 WireGuard TNAP Server Plugin

Self-hosted WireGuard VPN server plugin for Enigma2 satellite receivers. Transform your receiver into a secure VPN gateway for remote access.

## ⚠️ IMPORTANT: Mutual Exclusivity

**This plugin CANNOT be installed alongside the Firewall Security plugin.**

Both plugins manage iptables firewall rules but use **incompatible security models**:
- **WireGuard Plugin**: VPN-only access (internet blocked)
- **Firewall Plugin**: Selective internet access (whitelist-based)

Installing both simultaneously will cause connection failures and security conflicts.

**You must choose ONE approach.** See [Which Plugin Should I Use?](#which-plugin-should-i-use) below.

## Features

- **One-Click Installation**: Automated WireGuard server setup
- **GUI Management**: Full Enigma2 integration with skin-adaptive design
- **Client Configuration**: Automatic QR code generation for mobile devices
- **Backup/Restore**: Preserve VPN configuration across reflashes
- **Universal Compatibility**: Works with all TNAP/OpenPLi supported receivers
- **Minimal Dependencies**: Self-contained installation scripts

## What is WireGuard?

WireGuard is a modern, high-performance VPN protocol that:
- Runs in kernel space for maximum speed
- Uses state-of-the-art cryptography
- Has minimal attack surface (< 4,000 lines of code)
- Provides better performance than OpenVPN/IPSec

## Use Cases

- **Remote Access**: Access your receiver and home network from anywhere
- **Secure Streaming**: Watch your satellite TV remotely over encrypted tunnel
- **IoT Gateway**: Secure access to home automation devices
- **Privacy**: Encrypt all traffic when on public WiFi

## Which Plugin Should I Use?

### Use WireGuard Plugin if:
- ✅ You want VPN-only remote access
- ✅ You prefer zero internet exposure
- ✅ You access receiver only via VPN tunnel
- ✅ You want simple "connect via VPN" experience
- ✅ **RECOMMENDED for most users** (better security)

### Use Firewall Plugin if:
- ✅ You need selective internet access (whitelist specific IPs)
- ✅ You want to allow certain remote IPs direct access
- ✅ You need attack monitoring and logging
- ✅ Your receiver must be internet-facing

**Cannot decide?** Choose **WireGuard** - it's more secure and easier to use.

## Installation

### Via OpenPLi/TNAP Feed

```bash
opkg update
opkg install enigma2-plugin-extensions-wireguard-tnap
```

### Manual Installation

1. Download the `.ipk` package from releases
2. Transfer to receiver via SCP/FTP
3. Install:
```bash
opkg install enigma2-plugin-extensions-wireguard-tnap_*.ipk
```

## Quick Start

### Initial Setup

1. Access plugin: **Menu > Extensions > WireGuard TNAP Server**
2. Press **GREEN** to start installation
3. Wait for automatic installation (downloads kernel modules and tools)
4. Server starts automatically on completion

### View Server Status

1. Open plugin
2. Press **GREEN** to view status
3. Status shows:
   - Server IP and port
   - Connected clients
   - Network configuration
   - QR code for client setup

### Add Client

The installer creates a default client configuration at:
```
/etc/wireguard/client.conf
```

To add this client to your mobile device:
1. View status in plugin (shows QR code)
2. Scan QR code with WireGuard mobile app
3. Connect

To add additional clients, edit `/etc/wireguard/wg0.conf` and add new peer entries.

## Configuration

### Server Configuration

Edit `/etc/wireguard/wg0.conf`:

```ini
[Interface]
Address = 10.99.99.1/24
ListenPort = 51820
PrivateKey = <auto-generated>

[Peer]
# Client 1
PublicKey = <client-public-key>
AllowedIPs = 10.99.99.2/32

[Peer]
# Client 2
PublicKey = <client-public-key>
AllowedIPs = 10.99.99.3/32
```

After editing, restart WireGuard:
```bash
wg-quick down wg0
wg-quick up wg0
```

### Client Configuration

Example client configuration:

```ini
[Interface]
Address = 10.99.99.2/24
PrivateKey = <client-private-key>
DNS = 8.8.8.8

[Peer]
PublicKey = <server-public-key>
Endpoint = <your-public-ip>:51820
AllowedIPs = 10.99.99.0/24, 192.168.1.0/24
PersistentKeepalive = 25
```

**Note**: Replace `<your-public-ip>` with your receiver's public IP or dynamic DNS hostname.

## Network Configuration

### Port Forwarding

Forward UDP port **51820** on your router to your receiver's IP:

```
Protocol: UDP
External Port: 51820
Internal Port: 51820
Internal IP: 192.168.1.X (your receiver)
```

### Dynamic DNS (Optional)

If your ISP assigns dynamic IP addresses, use a DDNS service:
- No-IP
- DuckDNS
- Dynu

Update client config with your DDNS hostname instead of IP.

## Backup and Restore

### Automatic Backup

WireGuard configuration is automatically backed up during:
- OpenPLi/TNAP backups
- Manual backup via plugin

Backup includes:
- Server configuration (`/etc/wireguard/wg0.conf`)
- Private/public keys
- Client configurations

### Manual Backup

```bash
/usr/lib/enigma2/python/Plugins/Extensions/WireGuard/wireguard-backup-helper.sh
```

### Restore After Reflash

1. Restore your Enigma2 backup
2. Reinstall WireGuard plugin
3. Run post-restore script:
```bash
/usr/lib/enigma2/python/Plugins/Extensions/WireGuard/wireguard-post-restore.sh
```

## Uninstallation

### Via Plugin GUI

1. Open plugin
2. Press **RED** to uninstall
3. Confirm removal

### Manual Uninstallation

```bash
/usr/lib/enigma2/python/Plugins/Extensions/WireGuard/wireguard-uninstall.sh
```

This removes:
- WireGuard kernel modules
- Configuration files
- Client configurations
- Plugin files

**Note**: Private keys are preserved for future reinstallation.

## Troubleshooting

### Cannot connect to VPN

1. Verify server is running:
```bash
wg show
```

2. Check port forwarding is configured on router
3. Verify public IP/DDNS in client config is correct
4. Check firewall allows UDP 51820:
```bash
iptables -L -n | grep 51820
```

### Server not starting

Check system logs:
```bash
dmesg | grep wireguard
logread | grep wireguard
```

Common issues:
- Kernel module not loaded: `modprobe wireguard`
- Port already in use: Change ListenPort in config
- Incorrect permissions: `chmod 600 /etc/wireguard/wg0.conf`

### Poor VPN performance

- Verify MTU settings (default 1420)
- Check receiver CPU usage (WireGuard is efficient but hardware matters)
- Test different endpoint ports if ISP throttles VPN traffic

### Connection drops frequently

Add to client config:
```ini
PersistentKeepalive = 25
```

This sends keepalive packets every 25 seconds to maintain NAT mappings.

## Hardware Compatibility

Tested on:
- Octagon SF8008
- Edision osmio4k
- All TNAP/OpenPLi supported receivers with kernel 4.x+

## Requirements

- Enigma2 receiver (OpenPLi/TNAP image)
- Linux kernel 3.10+ (5.6+ recommended for built-in WireGuard)
- Internet connection
- Public IP or port forwarding capability
- 10MB free storage space

## Security Considerations

- WireGuard uses modern cryptography (Curve25519, ChaCha20, Poly1305)
- Private keys are auto-generated and stored securely
- No passwords needed - public key authentication only
- Minimal attack surface compared to traditional VPNs
- Regular updates recommended for security patches

## License

GNU General Public License v2.0

Copyright (C) 2025 TNAP Development Team

This program is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.

## Credits

- **Original Development**: TNAP Team
- **Documentation**: Claude Code (claude-sonnet-4-5-20250929)
- **Testing**: Community contributors
- **WireGuard**: Jason A. Donenfeld and contributors

## Links

- GitHub: https://github.com/EB-TNAP/enigma2-plugin-extensions-wireguard-tnap
- WireGuard Official: https://www.wireguard.com/
- Issue Tracker: https://github.com/EB-TNAP/enigma2-plugin-extensions-wireguard-tnap/issues

## Support

For issues and questions:
1. Check this README and troubleshooting section
2. Review existing GitHub issues
3. Open new issue with:
   - Receiver model
   - Image version (OpenPLi/TNAP)
   - Error messages/logs
   - Steps to reproduce
